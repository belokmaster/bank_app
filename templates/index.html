<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Финансовый Трекер</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width: 900px; margin: 40px auto; background: #f0f2f5; color: #1c1e21; }
        h1, h2 { text-align: center; color: #333; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .summary-container { display: flex; justify-content: space-around; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 30px; grid-column: 1 / -1; }
        .summary-item { text-align: center; }
        .summary-item h3 { margin: 0; color: #606770; font-weight: normal; }
        .summary-item p { margin: 5px 0 0 0; font-size: 1.6em; font-weight: bold; }
        .income { color: #31a24c; }
        .expense { color: #fa383e; }
        .balance { color: #1877f2; }
        .form-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .table-container { margin-top: 30px; grid-column: 1 / -1; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        th { background: #333; color: #fff; }
        input, select, button { width: 100%; padding: 12px; margin-top: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; }
        button { background: #333; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 1em; }
        button:hover { opacity: 0.9; }
        button.delete { background: #fa383e; font-size: 0.9em; padding: 8px 12px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <h1>Финансовый Трекер</h1>

    <div class="summary-container">
        <div class="summary-item">
            <h3>Доходы</h3>
            <p class="income">{{ "%.2f"|format(totals.income) }}</p>
        </div>
        <div class="summary-item">
            <h3>Расходы</h3>
            <p class="expense">{{ "%.2f"|format(totals.expense) }}</p>
        </div>
        <div class="summary-item">
            <h3>Баланс</h3>
            <p class="balance">{{ "%.2f"|format(totals.balance) }}</p>
        </div>
    </div>

    <div class="grid-container">
        <div class="form-container">
            <h2>Добавить транзакцию</h2>
            <form action="/add" method="POST">
                <div class="form-grid">
                    <select name="type" id="type_select" onchange="updateTransactionCategories()">
                        <option value="Расход">Расход</option>
                        <option value="Доход">Доход</option>
                    </select>
                    <select name="category_id" id="category_select" onchange="updateSubcategories()" required>
                        <option value="">Сначала выберите тип</option>
                    </select>
                </div>
                <div class="form-grid">
                    <select name="subcategory_id" id="subcategory_select">
                        <option value="">Нет</option>
                    </select>
                    <input type="number" name="amount" placeholder="Сумма" step="0.01" required>
                </div>
                <input type="text" name="description" placeholder="Описание (необязательно)" class="full-width">
                <button type="submit" class="full-width">Сохранить транзакцию</button>
            </form>
        </div>
        
        <div class="form-container">
            <h2>Управление категориями</h2>
            <form action="/add_category" method="POST">
                <h3>Добавить категорию</h3>
                <div class="form-grid">
                    <input type="text" name="name" placeholder="Название категории" required>
                    <select name="type">
                        <option value="Расход">Расход</option>
                        <option value="Доход">Доход</option>
                    </select>
                </div>
                <button type="submit" class="full-width">Сохранить категорию</button>
            </form>
            <hr>
            <form action="/add_subcategory" method="POST">
                 <h3>Добавить подкатегорию</h3>
                <div class="form-grid">
                    <select name="category_id" id="all_category_select" required>
                        <option value="">Выберите категорию</option>
                    </select>
                    <input type="text" name="name" placeholder="Название подкатегории" required>
                </div>
                <button type="submit" class="full-width">Сохранить подкатегорию</button>
            </form>
        </div>
    </div>

    <div class="table-container">
        <h2>История транзакций</h2>
        <table>
            <thead>
                <tr>
                    <th>Дата</th>
                    <th>Тип</th>
                    <th>Категория</th>
                    <th>Подкатегория</th>
                    <th>Сумма</th>
                    <th>Описание</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody>
                {% for id, type, category, subcategory, amount, description, date in transactions %}
                <tr>
                    <td>{{ date }}</td>
                    <td>{{ type }}</td>
                    <td>{{ category or 'N/A' }}</td>
                    <td>{{ subcategory or 'N/A' }}</td>
                    <td>{{ "%.2f"|format(amount) }}</td>
                    <td>{{ description }}</td>
                    <td>
                        <form action="/delete/{{ id }}" method="POST" style="margin:0;">
                            <button class="delete" type="submit">Удалить</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const categoriesData = JSON.parse('{{ categories_data_json | safe }}');
        
        const typeSelect = document.getElementById('type_select');
        const categorySelect = document.getElementById('category_select');
        const subcategorySelect = document.getElementById('subcategory_select');
        const allCategorySelectForSub = document.getElementById('all_category_select');

        function updateTransactionCategories() {
            const selectedType = typeSelect.value;
            const categories = categoriesData[selectedType] || [];
            
            categorySelect.innerHTML = '<option value="">Выберите категорию</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
            updateSubcategories();
        }

        function updateSubcategories() {
            const selectedType = typeSelect.value;
            const selectedCategoryId = parseInt(categorySelect.value, 10);
            
            subcategorySelect.innerHTML = '<option value="">Нет</option>';
            
            if (!selectedCategoryId) return;

            const categories = categoriesData[selectedType] || [];
            const selectedCategory = categories.find(cat => cat.id === selectedCategoryId);

            if (selectedCategory && selectedCategory.subcategories) {
                selectedCategory.subcategories.forEach(subcategory => {
                    const option = document.createElement('option');
                    option.value = subcategory.id;
                    option.textContent = subcategory.name;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        function populateAllCategoriesSelect() {
            allCategorySelectForSub.innerHTML = '<option value="">Выберите категорию</option>';
            const allCategories = [...categoriesData['Доход'], ...categoriesData['Расход']];
            allCategories.sort((a, b) => a.name.localeCompare(b.name));

            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = `${category.name} (${category.type})`;
                allCategorySelectForSub.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateTransactionCategories();
            populateAllCategoriesSelect();
        });
    </script>
</body>
</html>